# ======================================================================
#  Configuración de Nginx para Despliegue en VPS (Frontend React Dockerizado)
#  Dominio: elratonsinverguencilla.es/cuentacuentos/
# ======================================================================
#
#  ARQUITECTURA:
#  - Frontend React servido por contenedor Docker (nginx:alpine) en puerto 8003
#  - Backend FastAPI servido por contenedor Docker en puerto 8002
#  - Este Nginx del host actúa como reverse proxy para ambos contenedores
#
#  DIFERENCIAS con la versión anterior (frontend estático):
#  1. Ya NO se sirven archivos estáticos desde /var/www/cuentacuentos/frontend/
#  2. /cuentacuentos/ ahora hace proxy al contenedor frontend (puerto 8003)
#  3. El contenedor frontend maneja internamente: SPA routing, cache de assets, gzip
#  4. Nginx del host solo enruta tráfico entre contenedores
#
#  DESPLIEGUE:
#  1. En local: docker-compose up --build
#  2. En VPS:   git pull && docker-compose up -d --build
#  3. Recargar: sudo nginx -t && sudo systemctl reload nginx
#
# ======================================================================

# ── Frontend React (Proxy al contenedor Docker) ──
# El contenedor frontend (nginx:alpine) se encarga de:
#   - Servir archivos estáticos del build de Vite
#   - Manejar React Router (try_files → index.html)
#   - Cache de assets con hash
#   - Compresión gzip
location /cuentacuentos/ {
    proxy_pass http://127.0.0.1:8003/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# ── Archivos de audio generados por el backend ──
location /cuentacuentos/data/audio/ {
    alias /var/www/cuentacuentos/backend/data/audio/;
    expires 1M;
    add_header Cache-Control "public";
}

# ── Endpoints de Autenticación (proxy al backend) ──
location = /cuentacuentos/token {
    rewrite /cuentacuentos/(.*) /$1 break;
    proxy_pass http://127.0.0.1:8002;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

location /cuentacuentos/users {
    rewrite /cuentacuentos/(.*) /$1 break;
    proxy_pass http://127.0.0.1:8002;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

location /cuentacuentos/forgot-password {
    rewrite /cuentacuentos/(.*) /$1 break;
    proxy_pass http://127.0.0.1:8002;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

location /cuentacuentos/reset-password {
    rewrite /cuentacuentos/(.*) /$1 break;
    proxy_pass http://127.0.0.1:8002;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

location /cuentacuentos/change-password {
    rewrite /cuentacuentos/(.*) /$1 break;
    proxy_pass http://127.0.0.1:8002;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# ── Documentación de la API ──
location /cuentacuentos/docs {
    proxy_pass http://127.0.0.1:8002/docs;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

location /cuentacuentos/redoc {
    proxy_pass http://127.0.0.1:8002/redoc;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# ── Health Check ──
location = /cuentacuentos/health {
    proxy_pass http://127.0.0.1:8002/health;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# ── API REST (proxy al backend) ──
location /cuentacuentos/api/ {
    rewrite /cuentacuentos/api/(.*) /api/$1 break;
    proxy_pass http://127.0.0.1:8002;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# ── OpenAPI JSON ──
location = /cuentacuentos/openapi.json {
    proxy_pass http://127.0.0.1:8002/openapi.json;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
