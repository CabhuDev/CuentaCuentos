# ======================================================================
#  Configuración de Nginx para Despliegue en VPS
#  Dominio: elratonsinverguencilla.es/cuentacuentos/
# ======================================================================

# ----------------------------------------------------------------------
#  INSTRUCCIONES DE DESPLIEGUE INICIAL (solo la primera vez)
# ----------------------------------------------------------------------
#
# Sigue estos pasos para la configuración inicial en tu VPS.
#
# 1. PREPARAR EL SERVIDOR:
#    - Conéctate a tu VPS (por ejemplo, con SSH).
#    - Crea el directorio raíz para el proyecto si no existe:
#      sudo mkdir -p /var/www/cuentacuentos
#      sudo chown -R $USER:$USER /var/www/cuentacuentos
#
#    - Clona tu repositorio de Git en este nuevo directorio:
#      cd /var/www/cuentacuentos
#      git clone <URL_DE_TU_REPOSITORIO_GIT> .
#
# 2. CONSTRUIR Y EJECUTAR EL BACKEND DOCKERIZADO:
#    - Navega al directorio del proyecto: cd /var/www/cuentacuentos
#    - Ejecuta Docker Compose para construir la imagen y levantar el contenedor en segundo plano:
#      docker-compose up --build -d
#    - Verifica que el contenedor está corriendo y que el puerto 8002 está mapeado: docker ps
#
# 3. CONFIGURAR NGINX:
#    - Abre el archivo de configuración de Nginx para tu sitio 'elratonsinverguencilla.es'.
#      (Normalmente se encuentra en /etc/nginx/sites-available/elratonsinverguencilla.es)
#
#    - Dentro del bloque `server { ... }` que ya tienes, PEGA los BLOQUES `location`
#      que se proporcionan a continuación.
#
# 4. RECARGAR NGINX:
#    - Guarda el archivo de configuración.
#    - Verifica que la sintaxis de Nginx es correcta: sudo nginx -t
#    - Si el test es exitoso, recarga Nginx: sudo systemctl reload nginx
#
# ----------------------------------------------------------------------

# ======================================================================
#  BLOQUES DE CONFIGURACIÓN DE NGINX
#  Copia y pega todos estos bloques `location` dentro de tu `server { ... }`
# ======================================================================

# Sirve el Frontend (HTML, CSS, JS)
location /cuentacuentos/ {
    alias /var/www/cuentacuentos/frontend/;
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    try_files $uri $uri/ =404;
    index index.html;
}

# Sirve los archivos de Audio estáticos
location /cuentacuentos/data/audio/ {
    alias /var/www/cuentacuentos/data/audio/;
    # Opcional: añade headers de caché para los archivos de audio,
    # ya que no cambian a menudo. Esto mejora el rendimiento.
    expires 1M;
    add_header Cache-Control "public";
}

# Redirige la documentación de la API al backend
location /cuentacuentos/docs {
    proxy_pass http://127.0.0.1:8002/docs;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
location /cuentacuentos/redoc {
    proxy_pass http://127.0.0.1:8002/redoc;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# Redirige el Health Check al backend
location = /cuentacuentos/health {
    proxy_pass http://127.0.0.1:8002/health;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# Redirige todas las llamadas a la API al backend (Reverse Proxy)
location /cuentacuentos/api/ {
    # Reescribe la URL para que el backend la entienda (quita /cuentacuentos, añade /api)
    rewrite /cuentacuentos/api/(.*) /api/$1 break;

    proxy_pass http://127.0.0.1:8002;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
